name: Run pi-gen
on: 
  workflow_dispatch:

jobs:
  pi-gen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - run: >
          mkdir -p test-stage/package-test && 
          echo -e "#!/bin/bash\napt-get install -y curl\ncurl -fsSL https://deb.nodesource.com/setup_16.x | bash -" > test-stage/package-test/00-run-chroot.sh &&
          chmod +x test-stage/package-test/00-run-chroot.sh &&
          echo "nodejs" > test-stage/package-test/01-packages && 
          echo -e "#!/bin/bash -e\nif [ ! -d \"\${ROOTFS_DIR}\" ]; then\n  copy_previous\nfi" > test-stage/prerun.sh

      - uses: ./
        id: build
        with:
          image-name: test
          stage-list: stage0 stage1 stage2 test-stage

      - run: tree 
      
      - uses: actions/upload-artifact@v3
        with:
          name: pi-gen-image
          path: ${{ steps.build.outputs.image-path }}

