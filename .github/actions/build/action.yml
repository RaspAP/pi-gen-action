name: 'Run pi-gen build'
inputs:
  config-file:
    description: 'Location of the pi-gen config file to use'
    required: true
  target-stage:
    description: 'Name of the pi-gen stage to run the build to'
    required: true
  pi-gen-version:
    description: 'Ref of the pi-gen repo to clone for building'
    required: true
  enable-noobs:
    description: 'Control whether a noobs image will be created as well'
    required: true
  pi-gen-dir:
    description: 'Temporary directory where to run pi-gen in container'
    required: false
    default: '/tmp/pi-gen'
runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v3
      repository: RPi-Distro/pi-gen
      ref: ${{ inputs.pi-gen-version }}
      path: ${{ inputs.pi-gen-dir }}

    - run: sudo modprobe binfmt_misc
      shell: bash

    - run: ./prepare-stages.sh ${{ inputs.pi-gen-dir }} ${{ inputs.config-file }} ${{ inputs.target-stage }} ${{ inputs.enable-noobs }}
      shell: bash

    - run: ${{ inputs.pi-gen-dir }}/build-docker.sh -c ${{ inputs.config-file }}
      shell: bash
